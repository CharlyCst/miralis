name: CI

on:
  push:
    branches: [ "main", "ci" ]
  pull_request:
    branches: [ "main", "ci" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  Mirage:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: --deny warnings
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # We fetch the whole git tree to be able to run tests on previous commits
        ref: ${{ github.event.pull_request.head.sha }} # Ignore automatic merge commit
    - uses: extractions/setup-just@v2 # Install `just`
    - name: Setup Toolchain
      run: just install-toolchain
    - name: Download QEMU
      run: sudo apt-get update && sudo apt-get install qemu-system-riscv64
    - name: Test
      # Specify shell to enforce fail fast behavior, see:
      # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#exit-codes-and-error-action-preference
      shell: bash
      run: |
        # First we check if there are merge commits in the PR
        echo "Checking that history is linear..."
        if [ ! -z "$(git rev-list --min-parents=2 HEAD)" ]; then
          echo "There are merge commits! Please rebase the PR to remove them"
          false
        fi

        # We run tests for all commits in the PR
        revisions=$(git rev-list origin/main..HEAD)
        for commit in $revisions; do
          echo ""
          echo "// ———————————————————————————————— Checkout ———————————————————————————————— //"
          echo "// Commit: $commit                           //"
          echo "// —————————————————————————————————————————————————————————————————————————— //"
          echo ""
          git checkout $commit
          just test
        done

